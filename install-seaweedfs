#!/bin/bash

### Script to install and configure SeaweedFS mini with Caddy reverse proxy in a Docker environment
### SeaweedFS provides scalable file storage via S3, WebDAV, static Filer
### Caddy provides TLS, authentication, and reverse proxy services

# -- USER DEFINED Configuration Variables -- #

DEBUG=${DEBUG:-1}

# - Container Images
SWFS_IMAGE=${SWFS_IMAGE:-"chrislusf/seaweedfs:latest"}
CADDY_IMAGE=${CADDY_IMAGE:-"caddy:latest"}

# - Basic Authentication
SWFS_USER=${SWFS_USER:-"admin"}             # Username for SeaweedFS Admin UI, Filer, Master
SWFS_PASSWORD=${SWFS_PASSWORD:-"changeme"}  # Password for SeaweedFS Admin UI, Filer, Master

# - Fully Qualified Domain Names (FQDNs)
HOST_FQDN=${HOST_FQDN:-"$(hostname).edge.lab"}              # FQDN for SeaweedFS host
SWFS_ADMIN_FQDN=${SWFS_ADMIN_FQDN:-"admin.$HOST_FQDN"}      # FQDN for SeaweedFS Admin UI and Caddy landing page
SWFS_MASTER_FQDN=${SWFS_MASTER_FQDN:-"master.$HOST_FQDN"}   # FQDN for SeaweedFS Master UI/API
SWFS_FILER_FQDN=${SWFS_FILER_FQDN:-"artifacts.$HOST_FQDN"}  # FQDN for SeaweedFS Filer UI/API
SWFS_S3_FQDN=${SWFS_S3_FQDN:-"s3.$HOST_FQDN"}               # FQDN for SeaweedFS S3 API
SWFS_WEBDAV_FQDN=${SWFS_WEBDAV_FQDN:-"share.$HOST_FQDN"}    # FQDN for SeaweedFS WebDav endpoint
MGMT_IP=$(hostname -I | awk '{print $1}')                   # Used as default_sni fallback for TLS in non-DNS environments

# - Service TCP Ports
SWFS_ADMIN_PORT=${SWFS_ADMIN_PORT:-"443"}
SWFS_MASTER_PORT=${SWFS_MASTER_PORT:-"9333"}
SWFS_FILER_PORT=${SWFS_FILER_PORT:-"8888"}
SWFS_S3_PORT=${SWFS_S3_PORT:-"8333"}
SWFS_WEBDAV_PORT=${SWFS_WEBDAV_PORT:-"7333"}
# Volume Server uses port 9340 in docker environment and is not exposed

ENABLE_WEBDAV=${ENABLE_WEBDAV:-"true"}              # Enable WebDAV Gateway over open http (no authentication)
ARTIFACTS_TO_DOWNLOAD=${ARTIFACTS_TO_DOWNLOAD:-""}  # List of artifact URLS to auto download with 'curl -k' and upload to SeaweedFS filer

# -- INTERNAL VARIABLES (do not edit) -- #
AIR_GAPPED_MODE=0
SAVE_MODE=0
INSTALL_MODE=0
UNINSTALL_MODE=0
PUSH_MODE=0
REGISTRY_MODE=0
REGISTRY_INFO=""
REG_FQDN=""
REG_PORT=""
REG_USER=""
REG_PASS=""
fqdn_pattern='^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$'
ipv4_pattern='^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$'
base_dir=$(pwd)

# -- Functions -- #

install_swfs () {
        echo "# -- SeaweedFS Installer Started - $(date) -- #" | tee -a seaweedfs-install.log
        mkdir -p /opt/caddy/srv
        mkdir -p /opt/seaweedfs/mini
        debug_run run_docker
        if [[ $AIR_GAPPED_MODE -eq 0 ]]; then
            download_binaries
        fi
        generate_caddyfile
        generate_compose_file
        generate_index_html
        echo "  Starting SeaweedFS and Caddy containers..."
        docker compose -f /opt/seaweedfs/seaweedfs-compose.yaml up -d
        echo "  Waiting for SeaweedFS and Caddy to start..."
        sleep 5 # add loop to check curl for a 200 response
        echo "  Creating default artifact directory on SeaweedFS Filer..."
        docker exec -it seaweed-mini curl -X POST http://localhost:$SWFS_FILER_PORT/artifacts/ && echo 
        upload_binaries
        generate_outputs
}

run_docker() {
  echo "  Verifying Docker Config..."
  if [[ $AIR_GAPPED_MODE -eq 0 ]]; then
    download_image_pull_push
    if [[ $PUSH_MODE -eq 1 ]]; then
      cat >$base_dir/utilities/images.txt <<EOF
$SWFS_IMAGE
$CADDY_IMAGE
EOF
      $base_dir/utilities/image_pull_push.sh -f $base_dir/utilities/images.txt push $REGISTRY_INFO $REG_USER $REG_PASS
    else
      $base_dir/utilities/image_pull_push.sh docker
      # Still grab registry cert if needed
      if [[ $REGISTRY_MODE -eq 1 ]]; then
        $base_dir/utilities/image_pull_push.sh reg-cert $REGISTRY_INFO
      fi
    fi
  else
    # AIR_GAPPED_MODE is set
    for file in "$base_dir/utilities/container_images_*.tar.gz"; do
      if [[ $PUSH_MODE -eq 1 ]]; then
        $base_dir/utilities/image_pull_push.sh -f $file push $REGISTRY_INFO $REG_USER $REG_PASS
      else
        $base_dir/utilities/image_pull_push.sh -f $file keep
      fi
    done
    # Still grab registry cert if needed
    if [[ $REGISTRY_MODE -eq 1 ]]; then
      $base_dir/utilities/image_pull_push.sh reg-cert $REGISTRY_INFO
    fi
  fi
  if [[ $REGISTRY_MODE -eq 1 ]]; then
    echo "  Logging into local registry $REG_FQDN:$REG_PORT ..."
    docker login $REG_FQDN:$REG_PORT -u "$REG_USER" -p "$REG_PASS"
  fi
}

generate_caddyfile () {
  if [[ $PUSH_MODE -eq 1 || $REGISTRY_MODE -eq 1 ]]; then
    local caddy_image_local="${REG_FQDN}:${REG_PORT}/library/$CADDY_IMAGE"
  else
    local caddy_image_local="$CADDY_IMAGE"
  fi
  CADDY_HASHED_PASSWORD=$(docker run --rm ${caddy_image_local} caddy hash-password --plaintext "${SWFS_PASSWORD}")
  echo "  Creating Caddyfile..." | tee -a seaweedfs-install.log
  cat > /opt/caddy/Caddyfile <<EOF
{
        debug
        default_sni $MGMT_IP
}
$SWFS_ADMIN_FQDN:$SWFS_ADMIN_PORT, https://$MGMT_IP:$SWFS_ADMIN_PORT {
        tls internal
        handle {
                root * /srv
                file_server
        }
        handle /static* {
                reverse_proxy seaweed-mini:23646
        }
        handle /login* {
                reverse_proxy seaweed-mini:23646
        }
        handle /logout* {
                reverse_proxy seaweed-mini:23646
        }
        handle /admin* {
                reverse_proxy seaweed-mini:23646
        }
        handle /cluster* {
                reverse_proxy seaweed-mini:23646
        }
        handle /storage* {
                reverse_proxy seaweed-mini:23646
        }
        handle /files* {
                reverse_proxy seaweed-mini:23646
        }
        handle /object-store* {
                reverse_proxy seaweed-mini:23646
        }
        handle /mq* {
                reverse_proxy seaweed-mini:23646
        }
        handle /metrics* {
                reverse_proxy seaweed-mini:23646
        }
        handle /logs* {
                reverse_proxy seaweed-mini:23646
        }
        handle /maintenance* {
                reverse_proxy seaweed-mini:23646
        }
        handle /api* {
                reverse_proxy seaweed-mini:23646
        }
        handle /artifacts* {
                @isDomain host $SWFS_ADMIN_FQDN
                redir @isDomain https://$SWFS_FILER_FQDN:$SWFS_FILER_PORT/artifacts permanent
                redir https://{host}:$SWFS_FILER_PORT/artifacts permanent
        }
}
$SWFS_FILER_FQDN:$SWFS_FILER_PORT, https://$MGMT_IP:$SWFS_FILER_PORT {
        tls internal
        handle /seaweedfsstatic/* {
                reverse_proxy seaweed-mini:8888
        }
        handle /artifacts* {
                basic_auth {
                        $SWFS_USER $CADDY_HASHED_PASSWORD
                }
                reverse_proxy seaweed-mini:8888
        }
        handle {
                @isDomain host $SWFS_FILER_FQDN
                redir @isDomain https://$SWFS_ADMIN_FQDN permanent
                redir https://{host} permanent
        }
}
$SWFS_MASTER_FQDN:$SWFS_MASTER_PORT, https://$MGMT_IP:$SWFS_MASTER_PORT {
        tls internal
        basic_auth {
                $SWFS_USER $CADDY_HASHED_PASSWORD
        }
        reverse_proxy seaweed-mini:9333
}
$SWFS_S3_FQDN:$SWFS_S3_PORT, https://$MGMT_IP:$SWFS_S3_PORT {
        tls internal
        reverse_proxy seaweed-mini:8333
}
EOF
if [[ "$ENABLE_WEBDAV" == "true" ]]; then
        cat >> /opt/caddy/Caddyfile <<EOF
http://$SWFS_WEBDAV_FQDN:$SWFS_WEBDAV_PORT, http://$MGMT_IP:$SWFS_WEBDAV_PORT {
        reverse_proxy seaweed-mini:7333
}
EOF
fi

}

generate_compose_file () {
  if [[ $PUSH_MODE -eq 1 || $REGISTRY_MODE -eq 1 ]]; then
    SWFS_IMAGE="${REG_FQDN}:${REG_PORT}/$SWFS_IMAGE"
    CADDY_IMAGE="${REG_FQDN}:${REG_PORT}/library/$CADDY_IMAGE"
  else
    SWFS_IMAGE="$SWFS_IMAGE"
    CADDY_IMAGE="$CADDY_IMAGE"
  fi
  echo "  Creating seaweedfs-compose.yaml..." | tee -a seaweedfs-install.log
  cat > /opt/seaweedfs/seaweedfs-compose.yaml <<EOF
services:
  seaweed-mini:
    image: $SWFS_IMAGE
    container_name: seaweed-mini
    command: >
      mini
      -admin.user "$SWFS_USER"
      -admin.password "$SWFS_PASSWORD"
      -dir=/data
    volumes:
      - /opt/seaweedfs/mini:/data
    networks:
      - seaweed_net
    restart: unless-stopped
  caddy:
    image: $CADDY_IMAGE
    container_name: seaweed-caddy
    ports:
      - "80:80" # Reserved for future automatic_https
      - "$SWFS_ADMIN_PORT:$SWFS_ADMIN_PORT"
      - "$SWFS_MASTER_PORT:$SWFS_MASTER_PORT"
      - "$SWFS_FILER_PORT:$SWFS_FILER_PORT"
      - "$SWFS_S3_PORT:$SWFS_S3_PORT"
      - "$SWFS_WEBDAV_PORT:$SWFS_WEBDAV_PORT"
    volumes:
      - /opt/caddy/Caddyfile:/etc/caddy/Caddyfile
      - /opt/caddy/srv/index.html:/srv/index.html
    networks:
      - seaweed_net
    restart: unless-stopped
    depends_on:
      - seaweed-mini
networks:
  seaweed_net: {}

EOF
}


generate_index_html () {
    echo "  Creating index.html files..." | tee -a seaweedfs-install.log
    cat > /opt/caddy/srv/index.html <<EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeaweedFS Artifacts</title>
    <style>
        body {
            box-sizing: border-box;
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Google Sans', 'Arial', sans-serif;
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .content-wrapper {
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .title {
            font-size: 48px;
            color: #8ab4f8;
            margin-bottom: 30px;
            font-weight: 500;
            letter-spacing: -0.5px;
            text-align: center;
        }
        .main-nav {
            list-style: none;
            padding: 0;
            margin: 0 0 40px 0;
            text-align: center;
            width: 100%;
        }
        .main-nav li {
            margin-bottom: 15px;
        }
        .link {
            font-size: 20px;
            color: #8ab4f8;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-block;
        }
        .link:hover {
            color: #c5e1a5;
            text-decoration: underline;
        }
        .endpoint-label {
            font-size: 18px;
            color: #b0b0b0;
            font-family: 'Courier New', monospace;
            background: #2a2a2a;
            padding: 4px 12px;
            border-radius: 6px;
            border: 1px solid #333;
            display: inline-block;
            margin-top: 5px;
        }
        .endpoint-tag {
            font-size: 14px;
            color: #8ab4f8;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: block;
            margin-bottom: 2px;
        }
        .doc-card {
            background-color: #252525;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .note {
            font-size: 18px;
            color: #a8dadc;
            margin-top: 0;
            margin-bottom: 30px;
            border-left: 4px solid #8ab4f8;
            padding-left: 15px;
        }
        .subtitle {
            font-size: 22px;
            color: #e0e0e0;
            margin-top: 25px;
            margin-bottom: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        .subtitle::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #8ab4f8;
            border-radius: 50%;
            margin-right: 12px;
        }
        .code-block {
            font-family: 'Courier New', monospace;
            background-color: #121212;
            color: #c5e1a5;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.6;
            text-align: left;
            display: block;
            border: 1px solid #333;
            white-space: pre;
            word-wrap: break-word;
            overflow-x: auto;
        }
        footer {
            margin-top: auto;
            padding-top: 40px;
            color: #555;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <h1 class="title">SeaweedFS Artifacts</h1>
        <ul class="main-nav">
            <li><a id="admin-link" class="link" href="/login">Admin Console →</a></li>
            <li><a id="master-link" class="link" target="_blank" rel="noopener noreferrer" href="#">Master Console →</a></li>
            <li><a id="artifacts-link" class="link" target="_blank" rel="noopener noreferrer" href="#">File Browser →</a></li>
        </ul>
        <div class="doc-card">
            <p class="note">This server uses the all-in-one 'weed mini' command to deploy the following single-node optimized SeaweedFS services: Master, Volume, & Filer server, Maintenance Worker, Admin UI, S3 Gateway, and WebDAV Gateway</p>
            <p class="note">Caddy is deployed on the front end to serve this landing page, provide local TLS with auto-renewing certificates, basic authentication, and a reverse proxy to security harden the SeaweedFS services</p>
            <div class="subtitle">S3 endpoint</div>
            <pre class="code-block" id="s3-url">loading...</pre>
            <div class="subtitle">WebDAV share - enabled: $ENABLE_WEBDAV</div>
            <pre class="code-block" id="webdav-url">loading...</pre>
            <p class="note">Manage files using the browser UI (link above) or use the following API commands</p>
            <div class="subtitle">Create Directory</div>
            <pre class="code-block" id="curl-mkdir">loading...</pre>
            <div class="subtitle">Upload File</div>
            <pre class="code-block" id="curl-upload">loading...</pre>
            <div class="subtitle">Download File</div>
            <pre class="code-block" id="curl-download">loading...</pre>
            <div class="subtitle">Delete File</div>
            <pre class="code-block" id="curl-delete">loading...</pre>
        </div>
        <footer>
            Powered by Caddy & SeaweedFS
        </footer>
    </div>
        <script>
            (function() {
                const currentHost = window.location.hostname;
                const isIP = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}\$/.test(currentHost);

                function getUrl(subdomain, port, path = "", protocol = "https") {
                        if (isIP) {
                                return \`\${protocol}://\${currentHost}:\${port}\${path}\`;
                        }
                        const newHost = currentHost.replace('admin', subdomain);
                        return \`\${protocol}://\${newHost}:\${port}\${path}\`;
                }
                const artifactsBase = getUrl('artifacts', '$SWFS_FILER_PORT', '/artifacts');
                document.getElementById('master-link').href = getUrl('master', '$SWFS_MASTER_PORT');
                document.getElementById('artifacts-link').href = artifactsBase;
                document.getElementById('s3-url').textContent = getUrl('s3', '$SWFS_S3_PORT');
                document.getElementById('webdav-url').textContent = getUrl('share', '$SWFS_WEBDAV_PORT', '/artifacts', 'http');
                document.getElementById('curl-mkdir').textContent =
\`curl -ku SWFS_USER:SWFS_PASSWORD \\\\\\  
   -X POST \${artifactsBase}/\`;
                document.getElementById('curl-upload').textContent =
\`curl -ku SWFS_USER:SWFS_PASSWORD \\\\\\  
   -X POST \${artifactsBase}/file.txt \\\\\\  
   -F file=@/path/to/localfile.txt\`;
                document.getElementById('curl-download').textContent =
\`curl -ku SWFS_USER:SWFS_PASSWORD \\\\\\  
   \${artifactsBase}/file.txt \\\\\\  
   -o localfile.txt\`;
                document.getElementById('curl-delete').textContent =
\`curl -ku SWFS_USER:SWFS_PASSWORD \\\\\\  
   -X DELETE \${artifactsBase}/file.txt\`;
            })();
        </script>
</body>
</html>
EOF
}

download_image_pull_push () {
    if [[ ! -f $base_dir/utilities/image_pull_push.sh ]]; then
        echo "  Downloading image_pull_push.sh..."
        curl -sfL https://github.com/Chubtoad5/images-pull-push/raw/refs/heads/main/image_pull_push.sh  -o $base_dir/utilities/image_pull_push.sh
        chmod +x $base_dir/utilities/image_pull_push.sh
    fi
}
generate_outputs () {
  cat >> seaweedfs-install.log <<EOF
# -- SeaweedFS Installer Finished - $(date) -- #

Docker compose file:   /opt/seaweedfs/seaweedfs-compose.yaml
SeaweedFS data dir:    /opt/seaweedfs/mini
Caddyfile:             /opt/caddy/Caddyfile
Caddy web root:        /opt/caddy/srv/
To run weed commands:  docker exec -it seaweed-mini weed <command>
To run caddy commands: docker exec -it seaweed-caddy caddy <command>
 
The following services are accessible by IP or FQDN if DNS is configured:
  Master UI:    https://$SWFS_MASTER_FQDN:$SWFS_MASTER_PORT
  Filer UI:     https://$SWFS_FILER_FQDN:$SWFS_FILER_PORT/artifacts
  S3 Endpoint:  https://$SWFS_S3_FQDN:$SWFS_S3_PORT
  WebDAV:       http://$SWFS_WEBDAV_FQDN:$SWFS_WEBDAV_PORT
  Admin UI:     https://$SWFS_ADMIN_FQDN:$SWFS_ADMIN_PORT

Master UI, Filer UI, Admin UI require authentication:
  Username: $SWFS_USER
  Password: $SWFS_PASSWORD
If Root CA certificate trust is required for TLS connections, download from Caddy container:
  docker exec -it seaweed-caddy cat /data/caddy/pki/authorities/local/root.crt > seaweedfs-root-ca.crt

Caddy landing page: https://$SWFS_ADMIN_FQDN:$SWFS_ADMIN_PORT

EOF
  echo
  cat seaweedfs-install.log | tail -21
  echo
}

download_binaries () {
  echo "  Downloading artifact binaries..." | tee -a seaweedfs-install.log
  cd $base_dir/utilities/artifacts
  read -a ARTIFACTS_TO_DOWNLOAD_ARRAY <<< "$ARTIFACTS_TO_DOWNLOAD"
  for url in "${ARTIFACTS_TO_DOWNLOAD_ARRAY[@]}"; do
        echo "  Downloading $(basename $url)..." | tee -a ../seaweedfs-install.log
        curl -kfLO "$url"
  done
  cd $base_dir
}

upload_binaries () {
  echo "  Uploading artifact binaries to SeaweedFS Filer..." | tee -a seaweedfs-install.log
  for file in $base_dir/utilities/artifacts/*; do
        if [[ -f "$file" ]]; then
            curl -ku $SWFS_USER:$SWFS_PASSWORD -X POST https://$MGMT_IP:$SWFS_FILER_PORT/artifacts/$(basename "$file") -F file=@$base_dir/utilities/artifacts/$(basename "$file")
        fi
  done
}

debug_run() {
  if [ "$DEBUG" -eq 1 ]; then
    echo "--- DEBUG: Running '$*' ---"
    "$@"
    local status=$?
    echo "--- DEBUG: Finished '$*' with status $status ---"
    return $status
  else
    "$@" >/dev/null 2>&1
    return $?
  fi
}

check_root_privileges() {
  if [[ $EUID != 0 ]]; then
    echo "This script must be run with sudo or as the root user."
    exit 1
  fi
}

os_check () {
    # Get OS information from /etc/os-release
    if [[ -f /etc/os-release ]]; then
        # shellcheck disable=SC1091
        source /etc/os-release
        OS_ID_LIKE="${ID_LIKE:-}"
        OS_ID="${ID:-}"
    else
        echo "Unknown or unsupported OS $OS_ID."
        exit 1
    fi
    if [[ ! "$OS_ID" =~ ^(ubuntu|debian|rhel|centos|rocky|almalinux|fedora|sles|opensuse-leap)$ ]]; then
        echo "Unknown or unsupported OS $OS_ID."
        exit 1
    fi
}

run_save () {
  echo "  Preparing SeaweedFS offline archive..."
  debug_run download_image_pull_push
  cat >$base_dir/utilities/images.txt <<EOF
$SWFS_IMAGE
$CADDY_IMAGE
EOF
  cd $base_dir/utilities
  debug_run ./image_pull_push.sh -f $base_dir/utilities/images.txt save
  cd $base_dir
  debug_run download_binaries
  tar czf $base_dir/swfs-save.tar.gz utilities install-seaweedfs
  echo "  created 'swfs-save.tar.gz' for air-gapped deployment."
}

uninstall_swfs () {
    echo "# -- SeaweedFS Uninstaller Started - $(date) -- #" | tee -a seaweedfs-uninstall.log
    echo "  Stopping and removing SeaweedFS and Caddy containers..." | tee -a seaweedfs-uninstall.log
    docker compose -f /opt/seaweedfs/seaweedfs-compose.yaml down
    echo "  Removing SeaweedFS and Caddy data and configuration..." | tee -a seaweedfs-uninstall.log
    rm -rf /opt/seaweedfs
    rm -rf /opt/caddy
    echo "# -- SeaweedFS Uninstaller Finished - $(date) -- #" | tee -a seaweedfs-uninstall.log
}

display_args() {
    echo "  AIR_GAPPED_MODE: $AIR_GAPPED_MODE"
    echo "  INSTALL_MODE: $INSTALL_MODE"
    echo "  UNINSTALL_MODE: $UNINSTALL_MODE"
    echo "  DEBUG: $DEBUG"
    echo "  PUSH_MODE: $PUSH_MODE"
    echo "  SAVE_MODE: $SAVE_MODE"
    echo "  REGISTRY_MODE: $REGISTRY_MODE"
    echo "  REGISTRY_INFO: $REGISTRY_INFO"
    echo "  REG_FQDN: $REG_FQDN"
    echo "  REG_PORT: $REG_PORT"
    echo "  REG_USER: $REG_USER"
    echo "  REG_PASS: $REG_PASS"
    echo "  OS: $OS_ID"
}

# --- CLI Help --- #

help() {
  cat <<EOF
Usage: $0 [command] [option]

Commands:
  help              | Display this help message
  install           | Install and configure SeaweedFS and Caddy (Docker Compose)
  save              | Prepare offline archive for air-gapped deployment
  uninstall         | Uninstall SeaweedFS and Caddy including data and configuration

Options:
  push              | Push SeaweedFS and Caddy images to a local registry, must include -registry option
  -registry         | Registry credentials for pushing or pulling from local registry (Format: -registry [registry:port username password])

Examples:
  $0 install
  $0 save
  $0 uninstall
  $0 install -registry myregistry:5000 user password
  $0 install push -registry myregistry:5000 user password
EOF
  exit 1
}




# --- CLI Wrapper --- #
if [[ "$#" -eq 0 ]]; then
    echo "Error: No arguments provided."
    help
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    help|--help|-h) help ;;
    install)
      INSTALL_MODE=1
      ;;
    save)
      SAVE_MODE=1
      ;;
    push)
      PUSH_MODE=1
      ;;
    uninstall)
      UNINSTALL_MODE=1
      ;;
    -registry)
      REGISTRY_MODE=1
      REGISTRY_INFO="${2:-}"
      REG_USER="${3:-}"
      REG_PASS="${4:-}"
      if [[ -z "$REG_USER" || -z "$REG_PASS" ]]; then
          echo "Error: Registry info requires a username and password. Format: -registry [registry:port username password]"
          echo "Use '--help' for usage."
          exit 1
      fi
      shift 3
      ;;
    *)
      echo "Invalid argument: $1"
      echo
      ;;
  esac
  shift
done

check_root_privileges
os_check

# -- Argument Validation -- #
if [[ $INSTALL_MODE -eq 1 ]]; then 
  if [[ $UNINSTALL_MODE -eq 1 || $SAVE_MODE -eq 1 ]]; then 
    echo "Error: install, offline-prep, or uninstall cannot be used together."; exit 1; fi
fi
if [[ $UNINSTALL_MODE -eq 1 ]]; then 
  if [[ $INSTALL_MODE -eq 1 || $SAVE_MODE -eq 1 ]]; then 
    echo "Error: install, offline-prep, or uninstall cannot be used together.";exit 1; fi
  if [[ $PUSH_MODE -eq 1 || $REGISTRY_MODE -eq 1 ]]; then
    echo "Error: push or registry cannot be used with uninstall."; exit 1; fi
fi
if [[ $SAVE_MODE -eq 1 ]]; then 
  if [[ $INSTALL_MODE -eq 1 || $UNINSTALL_MODE -eq 1 ]]; then 
    echo "Error: install, offline-prep, or uninstall cannot be used together."; exit 1; fi
  if [[ $PUSH_MODE -eq 1 || $REGISTRY_MODE -eq 1 ]]; then
    echo "Error: push or registry cannot be used with save."; exit 1; fi
fi
if [[ $PUSH_MODE -eq 1 ]]; then 
  if [[ $SAVE_MODE -eq 1 || $UNINSTALL_MODE -eq 1 ]]; then
    echo "Error: save or uninstall cannot be used with push."; exit 1; fi
fi
if [[ "$REGISTRY_MODE" == "1" ]]; then
    if [[ "$REGISTRY_INFO" =~ ^https?:// ]]; then
        echo "Error: registry info must be a valid FQDN or IPv4 format. i.e. 'my.regsitry.com:443'."
        exit 1
    fi
    REG_FQDN=$(echo "$REGISTRY_INFO" | cut -d':' -f1)
    REG_PORT=$(echo "$REGISTRY_INFO" | cut -d':' -f2)
    if [[ ! ( "$REG_FQDN" =~ $fqdn_pattern || "$REG_FQDN" =~ $ipv4_pattern ) ]]; then
        echo "Error: Registry url must be a valid FQDN or IPv4 format. i.e. 'my.regsitry.com' or '192.168.1.50'."
        exit 1
    fi
    if [[ "$REG_PORT" =~ ^[0-9]+$ ]]; then
        if [[ "$REG_PORT" -lt 1 || "$REG_PORT" -gt 65535 ]]; then
            echo "Error: Registry port must be a number between 1 and 65535."
            exit 1
        fi
    else
        echo "Error: Registry port must be a number between 1 and 65535."
        exit 1
    fi
fi
[[ ! -f $base_dir/swfs-save.tar.gz ]] || AIR_GAPPED_MODE=1




# -- Main Logic -- #

echo "### SeaweedFS Installer Started - $(date) ###"
display_args

[[ -d $base_dir/utilities/artifacts ]] || mkdir -p $base_dir/utilities/artifacts
if [[ $INSTALL_MODE -eq 1 ]]; then
  echo "### SeaweedFS/Caddy Installation Starting ###"
  install_swfs
fi
if [[ $SAVE_MODE -eq 1 ]]; then
  echo "### SeaweedFS/Caddy Save Starting ###"
  run_save
fi
if [[ $UNINSTALL_MODE -eq 1 ]]; then 
  echo "### SeaweedFS/Caddy Uninstallation Starting ###"
  uninstall_swfs
fi
echo "### SeaweedFS Installer Finished - $(date) ###"